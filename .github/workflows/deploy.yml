name: Deploy to American Health Journal

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout source repository
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        # Removed cache: 'npm' to prevent 'dependencies lock file not found' error
    
    - name: Install dependencies
      run: npm install --no-audit --no-fund
    
- name: Build project
  run: |
    # Set the base path for Vite using the generated slug
    export VITE_BASE_PATH="/${{ steps.slug.outputs.slug }}/"
    npm run build
    
    - name: Generate custom slug
      id: slug
      run: |
        REPO_NAME="${{ github.event.repository.name }}"
        TIMESTAMP=$(date -u +"%Y%m%d-%H%M%S")
        SLUG="${REPO_NAME}-${TIMESTAMP}"
        echo "slug=${SLUG}" >> $GITHUB_OUTPUT
        echo "Generated slug: ${SLUG}"
    
    - name: Checkout target repository
      uses: actions/checkout@v3
      with:
        repository: ${{ github.repository_owner }}/americanhealthjournal-host
        token: ${{ secrets.GH_TOKEN }}
        path: target-repo
    
    - name: Copy build to target repository
      run: |
        # Creates the directory directly at the root of the target repo
        mkdir -p target-repo/${{ steps.slug.outputs.slug }}

        # Copies files into the root slug directory, NOT into /landings
        if [ -d "dist" ]; then
          cp -r dist/* target-repo/${{ steps.slug.outputs.slug }}/
        elif [ -d "build" ]; then
          cp -r build/* target-repo/${{ steps.slug.outputs.slug }}/
        else
          echo "Error: No dist/ or build/ directory found"
          exit 1
        fi
    
    - name: Commit and push changes
      run: |
        cd target-repo
        git config user.name "Magic Patterns Deploy Bot"
        git config user.email "andrei@skyhouseagency.com"
        git add .
        if git diff --staged --quiet; then
          echo "No changes to commit"
          exit 0
        fi
        git commit -m "Deploy landing page: ${{ steps.slug.outputs.slug }}"
        git push
    
    - name: Send Telegram notification
      env:
        LIVE_URL: https://blog.americanhealthjournal.org/${{ steps.slug.outputs.slug }}
        REPO_NAME: ${{ github.event.repository.name }}
        SLUG: ${{ steps.slug.outputs.slug }}
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        # The issue was the unquoted newlines in the MESSAGE string.
        # By putting the entire MESSAGE on one line, we avoid YAML parsing issues.
        MESSAGE="üöÄ *New Landing Page Deployed*\n\nüìÑ *Page:* ${REPO_NAME}\nüîó *URL:* ${LIVE_URL}\nüìÖ *Slug:* ${SLUG}\n‚è∞ *Deployed:* $(date -u +'%Y-%m-%d %H:%M:%S UTC')\n\nReady for use in ads! üéØ"
        
        curl -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{
            \"chat_id\": \"${TELEGRAM_CHAT_ID}\",
            \"text\": \"${MESSAGE}\",
            \"parse_mode\": \"Markdown\",
            \"disable_web_page_preview\": false
          }" || echo "Telegram notification failed (non-critical)"


